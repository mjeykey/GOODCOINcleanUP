<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>GoodCoin Room Tabs ‚Äì Symbole only</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-main: #ffeef8;
      --bg-card: #ffffffdd;
      --accent: #ff9ac6;
      --accent-strong: #ff6f9c;
      --text-main: #442135;
      --text-soft: #7f5871;
      --shadow-soft: 0 18px 40px rgba(172, 113, 152, 0.6);
      --radius-xl: 22px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fff6fb, #ffdff2, #ffd3f2);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      max-width: 1120px;
      width: 100%;
      margin: 14px;
      border-radius: 30px;
      background: linear-gradient(135deg, #fff7fc, #ffeef7);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 14px 18px 10px;
      border-bottom: 1px solid rgba(255, 163, 203, 0.5);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.4rem;
    }

    .subtitle {
      font-size: 0.82rem;
      color: var(--text-soft);
      max-width: 520px;
    }

    .coins-box {
      min-width: 210px;
      border-radius: 18px;
      padding: 8px 12px;
      background: radial-gradient(circle at top left, #fff7d3, #ffe1a5);
      color: #6b4a13;
      box-shadow: 0 10px 20px rgba(188, 147, 74, 0.6);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .coins-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .coins-main-value { font-size: 1.1rem; }

    .coins-extra {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.72rem;
    }

    .progress-wrap {
      margin-top: 3px;
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.6);
      overflow: hidden;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff9a9e, #fad0c4);
      transition: width 0.2s ease-out;
    }

    .room-tabs {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 8px 14px 10px;
      background: rgba(255, 242, 252, 0.9);
      border-bottom: 1px solid rgba(255, 163, 203, 0.45);
    }

    .room-tabs::-webkit-scrollbar { height: 6px; }
    .room-tabs::-webkit-scrollbar-thumb {
      background: rgba(187, 132, 160, 0.7);
      border-radius: 999px;
    }

    .room-tab {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.82rem;
      border: 1px solid rgba(241, 143, 186, 0.75);
      background: #ffffffdd;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 7px 14px rgba(171, 115, 151, 0.35);
      white-space: nowrap;
      transition: transform 0.12s, box-shadow 0.15s, background 0.15s;
    }

    .room-tab-emoji { font-size: 1.05rem; }

    .room-tab.active {
      background: linear-gradient(135deg, #ffdeeb, #ffe8fb);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(171, 115, 151, 0.6);
    }

    main { padding: 14px 16px 18px; }

    .room-view {
      display: grid;
      grid-template-columns: minmax(0, 340px) minmax(0, 1fr);
      gap: 14px;
    }

    @media (max-width: 860px) {
      .room-view { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 10px 11px;
      box-shadow: 0 16px 32px rgba(171, 115, 151, 0.55);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .room-headline { display: flex; flex-direction: column; gap: 4px; }

    .room-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .room-emoji-big {
      font-size: 1.6rem;
      border-radius: 999px;
      padding: 7px;
      background: #fff2fd;
    }

    .room-name { font-size: 1.1rem; }

    .room-info {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .room-visual {
      margin-top: 4px;
      border-radius: 18px;
      padding: 10px;
      background: radial-gradient(circle at top, #ffeaf6, #ffd8f1);
      border: 1px solid rgba(244, 143, 186, 0.9);
      position: relative;
      overflow: hidden;
      min-height: 190px;
    }

    .room-photo {
      position: absolute;
      inset: 12px 10px 38px 10px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 8px 16px rgba(149, 94, 129, 0.55);
      opacity: 0.95;
    }

    .room-floor {
      position: absolute;
      inset: 55% -20px -20px -20px;
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.3),
        rgba(255, 255, 255, 0.3) 6px,
        rgba(255, 211, 238, 0.7) 6px,
        rgba(255, 211, 238, 0.7) 12px
      );
      opacity: 0.8;
    }

    .room-object {
      position: absolute;
      border-radius: 50%;
      padding: 6px;
      background: #ffffffdd;
      box-shadow: 0 6px 12px rgba(149, 94, 129, 0.55);
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.08s;
    }

    .room-object:hover {
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 8px 16px rgba(149, 94, 129, 0.8);
      background: #fffdfd;
    }

    .room-object-emoji { font-size: 1.1rem; }

    .room-label-top {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.8rem;
      color: var(--text-soft);
      z-index: 2;
    }

    .room-label-tip {
      position: absolute;
      bottom: 8px;
      right: 12px;
      font-size: 0.72rem;
      color: var(--text-soft);
      z-index: 2;
    }

    .tiny { font-size: 0.7rem; color: #a16b8b; }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tasks-title { font-size: 0.96rem; }

    .tasks-sub {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .task-buttons { display: flex; gap: 6px; flex-wrap: wrap; }

    .btn-soft {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(197, 135, 171, 0.9);
      background: #fff6fb;
      color: var(--text-main);
      cursor: pointer;
    }

    .btn-soft.danger {
      border-style: dashed;
      border-color: rgba(241, 90, 126, 0.95);
      background: #ffe5ec;
      color: #b52f4c;
    }

    .task-list {
      list-style: none;
      margin: 6px 0 4px;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 5px;
      max-height: 210px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.82rem;
    }

    .task-item input[type="checkbox"] {
      margin-top: 2px;
      cursor: pointer;
    }

    .task-label { cursor: pointer; }

    .task-label.done {
      text-decoration: line-through;
      color: #ae7d9a;
    }

    .task-meta {
      font-size: 0.7rem;
      color: #b17293;
      margin-top: 1px;
    }

    .tasks-footer {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.74rem;
      color: var(--text-soft);
    }

    .rename-input {
      font-size: 0.75rem;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(195, 143, 177, 0.9);
      background: #fff9fd;
      min-width: 150px;
    }

    .stats-line {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    @media (max-width: 720px) {
      .photos-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .photo-block {
      border-radius: 14px;
      padding: 6px;
      background: radial-gradient(circle at top, #ffe6f3, #ffddf0);
      border: 1px solid rgba(242, 143, 190, 0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .photo-title {
      font-size: 0.8rem;
      color: var(--text-main);
    }

    .photo-box {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.7);
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-placeholder {
      font-size: 0.78rem;
      color: var(--text-soft);
      padding: 8px;
      text-align: center;
    }

    .photo-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .photo-input { font-size: 0.75rem; }

    .share-row {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed rgba(193, 140, 175, 0.8);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .share-line {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .share-line input[type="checkbox"] { cursor: pointer; }

    .clan-badge {
      margin-top: 4px;
      border-radius: 18px;
      padding: 7px 10px;
      background: radial-gradient(circle at top, #fffde7, #ffe082, #ffb300);
      color: #4a2f00;
      font-size: 0.82rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 18px rgba(255, 236, 179, 0.9);
    }

    .clan-symbol {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #fffdf0, #ffd54f, #f9a825);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 0 10px rgba(214, 142, 44, 0.9);
    }

    .celebration-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 9999;
    }

    .celebration-layer.hidden { display: none; }

    .coin {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #fff9c4, #ffd54f, #f9a825);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #5d3b00;
      animation: coin-fall 0.9s ease-out forwards;
    }

    @keyframes coin-fall {
      0% { transform: translate3d(0, 0, 0) scale(0.5) rotateZ(0deg); opacity: 0; }
      10% { opacity: 1; }
      70% { transform: translate3d(0, -120px, 0) scale(1.1) rotateZ(180deg); }
      100% { transform: translate3d(0, 40px, 0) scale(0.8) rotateZ(360deg); opacity: 0; }
    }

    .win-flash {
      position: absolute;
      top: 18%;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, #fff, #ffe082, #ffb300);
      color: #4a2c00;
      font-size: 0.98rem;
      box-shadow: 0 0 20px rgba(255, 236, 179, 0.95);
      animation: win-pop 0.8s ease-out forwards;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    @keyframes win-pop {
      0% { transform: translateX(-50%) scale(0.3); opacity: 0; }
      30% { transform: translateX(-50%) scale(1.1); opacity: 1; }
      100% { transform: translateX(-50%) scale(0.6); opacity: 0; }
    }

    .clan-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 0;
      font-size: 0.8rem;
    }

    .clan-item {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(193, 140, 175, 0.5);
    }

    .clan-item span:first-child {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .analysis-photo-box {
      border-radius: 16px;
      padding: 10px;
      background: radial-gradient(circle at top, #ffe9f7, #ffdff5);
      border: 1px solid rgba(244, 143, 186, 0.9);
      min-height: 180px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .analysis-image-wrap {
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.8);
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .analysis-image {
      max-width: 100%;
      max-height: 240px;
      object-fit: cover;
      display: none;
    }

    .analysis-placeholder {
      font-size: 0.8rem;
      color: var(--text-soft);
      padding: 8px;
      text-align: center;
    }

    .analysis-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .analysis-select {
      width: 100%;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(195, 143, 177, 0.9);
      background: #fff9fd;
      font-size: 0.8rem;
    }

    .analysis-checklist {
      list-style: none;
      padding: 0;
      margin: 6px 0 0;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .analysis-checklist li {
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .analysis-notes {
      width: 100%;
      min-height: 60px;
      border-radius: 10px;
      border: 1px solid rgba(195, 143, 177, 0.9);
      padding: 6px 8px;
      font-size: 0.78rem;
      resize: vertical;
      background: #fff9fd;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="top-row">
        <div class="title-block">
          <div class="title-main">
            <span>üßπ‚ú®</span>
            <span>GoodCoin Room Tabs</span>
          </div>
          <div class="subtitle">
            Klickbare Symbole im Zimmer, GoodCoins f√ºr jede Mission, Clan-Bonus
            und ein Analyse-Tab f√ºr sp√§tere AI.
          </div>
        </div>
        <div class="coins-box">
          <div class="coins-row">
            <div>
              <div class="coins-main-value" id="totalCoinsText">0 GoodCoins heute</div>
              <div id="totalTasksText">0 von 0 Aufgaben erledigt</div>
            </div>
            <div>ü™ô</div>
          </div>
          <div class="progress-wrap">
            <div class="progress-inner" id="totalProgress"></div>
          </div>
          <div class="coins-extra">
            <span id="personalBestText">Dein Tagesrekord: 0 GoodCoins</span>
            <span id="clanPointsText">Clan-Punkte gesamt: 0</span>
          </div>
        </div>
      </div>
    </header>

    <nav class="room-tabs" id="roomTabs"></nav>

    <main>
      <div id="roomView" class="room-view">
        <section class="card">
          <div class="room-headline">
            <div class="room-name-row">
              <div class="room-emoji-big" id="roomEmoji">üç≥</div>
              <div>
                <div class="room-name" id="roomName">K√ºche</div>
                <div class="room-info" id="roomInfo">
                  Zone f√ºr Kochen, Sp√ºle und Arbeitsfl√§chen.
                </div>
              </div>
            </div>
          </div>

          <div class="room-visual" id="roomVisual">
            <img id="kitchenPhoto" class="room-photo" alt="Beispiel-Sp√ºle">
            <div class="room-floor"></div>
            <div class="room-label-top" id="roomLabelTop">
              Virtuelle Ansicht
            </div>
            <div class="room-label-tip" id="roomLabelTip">
              Symbole anklicken oder die Liste benutzen ‚Äì jede Aktion gibt GoodCoins.
            </div>

            <div class="room-object" id="obj1"></div>
            <div class="room-object" id="obj2"></div>
            <div class="room-object" id="obj3"></div>
            <div class="room-object" id="obj4"></div>
            <div class="room-object" id="obj5"></div>
            <div class="room-object" id="obj6"></div>
          </div>

          <div class="tiny">
            Im Zimmer sind nur Symbole anklickbar, keine Textfl√§chen.
            So bleibt alles spielerisch und leicht.
          </div>
        </section>

        <section class="card">
          <div class="tasks-header">
            <div>
              <div class="tasks-title">Mini-Missionen f√ºr dieses Zimmer</div>
              <div class="tasks-sub" id="roomStatsText">
                0 von 0 Aufgaben erledigt ‚Äì 0 GoodCoins hier.
              </div>
            </div>
            <div class="task-buttons">
              <button class="btn-soft" id="addTaskBtn">Neue Aufgabe</button>
              <button class="btn-soft danger" id="resetTaskBtn">Haken f√ºr dieses Zimmer l√∂schen</button>
            </div>
          </div>

          <ul class="task-list" id="taskList"></ul>

          <div class="tasks-footer">
            <div class="stats-line" id="rewardLine">
              Voll erledigt bringt dieses Zimmer 0 GoodCoins.
            </div>
            <div>
              <input id="renameInput" class="rename-input" type="text" placeholder="Zimmer umbenennen">
            </div>
          </div>

          <div class="photos-grid">
            <div class="photo-block">
              <div class="photo-title">Vorher</div>
              <div class="photo-box">
                <div class="photo-placeholder" id="beforePlaceholder">
                  Lade ein Vorher-Foto hoch, um deinen Startpunkt zu sehen.
                </div>
                <img id="beforeImage" class="photo-img" alt="Vorher-Foto">
              </div>
              <input id="beforeInput" class="photo-input" type="file" accept="image/*">
            </div>

            <div class="photo-block">
              <div class="photo-title">Nachher</div>
              <div class="photo-box">
                <div class="photo-placeholder" id="afterPlaceholder">
                  Lade dein Nachher-Foto hoch, wenn sich das Zimmer richtig gut anf√ºhlt.
                </div>
                <img id="afterImage" class="photo-img" alt="Nachher-Foto">
              </div>
              <input id="afterInput" class="photo-input" type="file" accept="image/*">
            </div>
          </div>

          <div class="share-row">
            <div class="share-line">
              <input type="checkbox" id="shareCheckbox">
              <label for="shareCheckbox">
                Ich w√§re bereit, diese Vorher/Nachher Story mit meinem Clan zu teilen.
              </label>
            </div>
            <div class="tiny">
              Wenn du das aktivierst und mindestens eine Aufgabe erledigt hast,
              wird der aktuelle GoodCoin-Wert dieses Zimmers einmalig als Clan-Punkte gutgeschrieben.
            </div>
            <div id="clanBadgeContainer"></div>
          </div>
        </section>
      </div>

      <div id="clanView" class="room-view" style="display:none;">
        <section class="card">
          <div class="room-headline">
            <div class="room-name-row">
              <div class="room-emoji-big">üõ°Ô∏è</div>
              <div>
                <div class="room-name">Clan-√úbersicht</div>
                <div class="room-info">
                  √úbersicht der GoodCoins, die aus deinen Zimmern bereits als Clan-Punkte gesammelt wurden.
                </div>
              </div>
            </div>
          </div>
          <div class="stats-line" id="clanSummaryText">
            Noch keine Clan-Punkte gesammelt.
          </div>
          <div class="tiny">
            Jede Zone, die du zum Teilen markierst, kann einmalig ihre GoodCoins als Clan-Punkte spenden.
            So profitiert die ganze Gruppe davon, dass du aufr√§umst.
          </div>
        </section>

        <section class="card">
          <div class="tasks-header">
            <div class="tasks-title">Beitr√§ge der Zimmer</div>
            <div class="tasks-sub">
              Zimmer und Zonen, die bereits GoodCoins in den Clan gef√ºllt haben.
            </div>
          </div>
          <ul class="clan-list" id="clanRoomList"></ul>
        </section>
      </div>

      <div id="analysisView" class="room-view" style="display:none;">
        <section class="card">
          <div class="room-headline">
            <div class="room-name-row">
              <div class="room-emoji-big">üì∑</div>
              <div>
                <div class="room-name">Foto-Analyse (Vorbereitung f√ºr AI)</div>
                <div class="room-info">
                  Lade ein Foto hoch, w√§hle grob den Bereich (K√ºche, Bad, etc.).
                  Die App baut dir eine Standard-Checkliste, die sp√§ter von einer AI ersetzt werden kann.
                </div>
              </div>
            </div>
          </div>

          <div class="analysis-photo-box">
            <div class="analysis-image-wrap">
              <img id="analysisImage" class="analysis-image" alt="Analyse-Foto">
              <div id="analysisPlaceholder" class="analysis-placeholder">
                Noch kein Foto ausgew√§hlt.
                Lade ein Bild deiner Zone hoch, damit die Checkliste dazu passt.
              </div>
            </div>
            <input id="analysisFileInput" type="file" accept="image/*" class="photo-input">
            <div class="tiny">
              Dieses Bild bleibt nur lokal in deinem Browser.
              Sp√§ter kann an dieser Stelle ein AI-Modell angeschlossen werden,
              das automatisch Zonen erkennt (Sp√ºle, Boden, Bett usw.).
            </div>
          </div>
        </section>

        <section class="card">
          <div class="tasks-header">
            <div>
              <div class="tasks-title">Auto-Checkliste zur Zone</div>
              <div class="tasks-sub" id="analysisStatsText">
                Bereich w√§hlen und Checkliste erzeugen.
              </div>
            </div>
          </div>

          <div class="analysis-controls">
            <select id="analysisAreaSelect" class="analysis-select">
              <option value="">Bereich ausw√§hlen</option>
              <option value="kitchen">K√ºche / Sp√ºle</option>
              <option value="bath">Bad</option>
              <option value="bedroom">Schlafzimmer</option>
              <option value="desk">Schreibtisch</option>
              <option value="living">Wohnbereich</option>
              <option value="chaos">Chaosecke</option>
            </select>
            <button id="analysisGenerateBtn" class="btn-soft">Checkliste erzeugen</button>
          </div>

          <ul id="analysisChecklist" class="analysis-checklist"></ul>

          <div class="tiny">
            Wenn dir die Liste gef√§llt, kannst du die Aufgaben in den passenden Zimmer-Tabs anlegen
            und dort GoodCoins sammeln. Dieser Tab ist dein Spielplatz f√ºr Foto-Experimente.
          </div>

          <textarea id="analysisNotes" class="analysis-notes"
            placeholder="Notizen oder Ideen f√ºr eine sp√§tere AI-Auswertung (z. B. ‚ÄöFoto zeigt √ºberf√ºllte Sp√ºle und Boden mit T√ºten‚Äò)."></textarea>
        </section>
      </div>
    </main>
  </div>

  <div id="celebrationLayer" class="celebration-layer hidden"></div>

  <script>
    const STORAGE_KEY = "goodcoin_room_tabs_symbols_v1";

    const ROOM_DEFS = [
      {
        id: "kitchen",
        name: "K√ºche",
        emoji: "üç≥",
        rewardTotal: 15,
        info: "Zone f√ºr Kochen, Sp√ºle und Arbeitsfl√§chen.",
        tasks: [
          "Sp√ºle frei r√§umen und gr√ºndlich reinigen",
          "Arbeitsfl√§chen abr√§umen und abwischen",
          "Geschirr in die Sp√ºlmaschine oder abwaschen",
          "M√ºlleimer pr√ºfen und bei Bedarf rausbringen",
          "Lebensmittel einsortieren (K√ºhlschrank, Schr√§nke)",
          "Boden kurz kehren oder wischen"
        ],
        visuals: [
          { emoji: "üßº", taskIndex: 0, style: { left:"18%", top:"50%" } },
          { emoji: "üßΩ", taskIndex: 1, style: { left:"48%", top:"32%" } },
          { emoji: "üçΩÔ∏è", taskIndex: 2, style: { left:"68%", top:"28%" } },
          { emoji: "üóëÔ∏è", taskIndex: 3, style: { left:"76%", top:"60%" } },
          { emoji: "ü•´", taskIndex: 4, style: { left:"32%", top:"22%" } },
          { emoji: "üßπ", taskIndex: 5, style: { left:"24%", top:"64%" } }
        ]
      },
      {
        id: "bath",
        name: "Bad",
        emoji: "üõÅ",
        rewardTotal: 12,
        info: "Waschbecken, Toilette, Dusche oder Wanne.",
        tasks: [
          "Waschbecken frei r√§umen und reinigen",
          "Spiegel mit Glasreiniger abwischen",
          "Toilette gr√ºndlich reinigen",
          "Dusch- oder Wannenbereich kurz s√§ubern",
          "Produkte sortieren (t√§glich, selten, wegwerfen)",
          "Boden wischen oder saugen"
        ],
        visuals: [
          { emoji: "üßº", taskIndex: 0, style: { left:"26%", top:"38%" } },
          { emoji: "ü™û", taskIndex: 1, style: { left:"18%", top:"16%" } },
          { emoji: "üöΩ", taskIndex: 2, style: { left:"60%", top:"44%" } },
          { emoji: "üõÅ", taskIndex: 3, style: { left:"40%", top:"50%" } },
          { emoji: "üß¥", taskIndex: 4, style: { left:"70%", top:"22%" } },
          { emoji: "üßª", taskIndex: 5, style: { left:"34%", top:"64%" } }
        ]
      },
      {
        id: "bedroom",
        name: "Schlafzimmer",
        emoji: "üõèÔ∏è",
        rewardTotal: 14,
        info: "Bett, Nachttisch, Kleiderstapel und Boden.",
        tasks: [
          "Bett frisch beziehen oder Decke glatt ausbreiten",
          "Kissen aufsch√ºtteln und anordnen",
          "Kleidung vom Bett entfernen und sortieren",
          "Nachttisch von Flaschen, Verpackungen, Kleinkram befreien",
          "Ein bis zwei St√ºhle oder Ecken von Kleidung befreien",
          "Boden rund um das Bett saugen oder kehren"
        ],
        visuals: [
          { emoji: "üõèÔ∏è", taskIndex: 0, style: { left:"20%", top:"46%" } },
          { emoji: "üõå", taskIndex: 1, style: { left:"36%", top:"32%" } },
          { emoji: "üß∫", taskIndex: 2, style: { left:"62%", top:"42%" } },
          { emoji: "üìö", taskIndex: 3, style: { left:"68%", top:"26%" } },
          { emoji: "üëï", taskIndex: 4, style: { left:"32%", top:"60%" } },
          { emoji: "üßπ", taskIndex: 5, style: { left:"15%", top:"64%" } }
        ]
      },
      {
        id: "desk",
        name: "Schreibtisch",
        emoji: "üíª",
        rewardTotal: 10,
        info: "Arbeitsfl√§che, Laptop, Kabel, Papierstapel.",
        tasks: [
          "Papierstapel grob sortieren (wichtig, sp√§ter, kann weg)",
          "M√ºll und Verpackungen entsorgen",
          "Kabel ordnen und b√ºndeln",
          "Nur Dinge auf dem Tisch lassen, die du heute brauchst",
          "Tischoberfl√§che gr√ºndlich abwischen",
          "Boden unter dem Tisch kurz saugen oder kehren"
        ],
        visuals: [
          { emoji: "üíª", taskIndex: 3, style: { left:"24%", top:"32%" } },
          { emoji: "üìÑ", taskIndex: 0, style: { left:"50%", top:"28%" } },
          { emoji: "üìé", taskIndex: 0, style: { left:"66%", top:"40%" } },
          { emoji: "üóëÔ∏è", taskIndex: 1, style: { left:"74%", top:"60%" } },
          { emoji: "üîå", taskIndex: 2, style: { left:"38%", top:"52%" } },
          { emoji: "üßπ", taskIndex: 5, style: { left:"18%", top:"64%" } }
        ]
      },
      {
        id: "living",
        name: "Wohnbereich",
        emoji: "üõãÔ∏è",
        rewardTotal: 10,
        info: "Sofa, Couchtisch, Decken, Snacks.",
        tasks: [
          "Decken zusammenlegen und ordentlich platzieren",
          "Kissen aufsch√ºtteln und sortieren",
          "Tisch von Snacks, Gl√§sern und Verpackungen befreien",
          "Oberfl√§chen abwischen",
          "Boden vor Sofa und Tisch saugen oder kehren"
        ],
        visuals: [
          { emoji: "üõãÔ∏è", taskIndex: 0, style: { left:"24%", top:"44%" } },
          { emoji: "üõãÔ∏è", taskIndex: 1, style: { left:"38%", top:"30%" } },
          { emoji: "‚òï", taskIndex: 2, style: { left:"64%", top:"38%" } },
          { emoji: "üßÉ", taskIndex: 2, style: { left:"52%", top:"52%" } },
          { emoji: "üßπ", taskIndex: 4, style: { left:"22%", top:"64%" } },
          { emoji: "üïØÔ∏è", taskIndex: 3, style: { left:"70%", top:"24%" } }
        ]
      },
      {
        id: "chaos",
        name: "Chaosecke",
        emoji: "üé≤",
        rewardTotal: 18,
        info: "Die verr√ºckte Zone, in der sich alles sammelt.",
        tasks: [
          "Alles in drei Haufen sortieren: behalten, sp√§ter, kann weg",
          "M√ºll sofort entsorgen",
          "Einen festen Platz f√ºr wichtige Dinge definieren",
          "Mindestens eine Fl√§che komplett freir√§umen",
          "Zum Schluss den Boden saugen oder kehren"
        ],
        visuals: [
          { emoji: "üì¶", taskIndex: 0, style: { left:"20%", top:"30%" } },
          { emoji: "üß∫", taskIndex: 0, style: { left:"40%", top:"46%" } },
          { emoji: "üóÇÔ∏è", taskIndex: 2, style: { left:"64%", top:"30%" } },
          { emoji: "üóëÔ∏è", taskIndex: 1, style: { left:"74%", top:"52%" } },
          { emoji: "üßπ", taskIndex: 4, style: { left:"26%", top:"64%" } },
          { emoji: "üéí", taskIndex: 3, style: { left:"50%", top:"22%" } }
        ]
      }
    ];

    function buildDefaultState() {
      const rooms = ROOM_DEFS.map(def => ({
        id: def.id,
        name: def.name,
        emoji: def.emoji,
        rewardTotal: def.rewardTotal,
        tasks: def.tasks.map(t => ({ text: t, done: false })),
        beforePhoto: null,
        afterPhoto: null,
        share: false,
        clanAwarded: false,
        clanAwardedPoints: 0
      }));
      return {
        rooms,
        selectedId: rooms[0].id,
        personalBest: 0,
        clanPoints: 0,
        analysis: {
          photo: null,
          area: "",
          checklist: [],
          notes: ""
        }
      };
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return buildDefaultState();
        const parsed = JSON.parse(raw);
        if (!parsed.rooms || !Array.isArray(parsed.rooms)) throw new Error("invalid");
        if (typeof parsed.personalBest !== "number") parsed.personalBest = 0;
        if (typeof parsed.clanPoints !== "number") parsed.clanPoints = 0;
        parsed.rooms.forEach(r => {
          if (typeof r.clanAwarded !== "boolean") r.clanAwarded = false;
          if (typeof r.clanAwardedPoints !== "number") r.clanAwardedPoints = 0;
        });
        if (!parsed.selectedId) parsed.selectedId = parsed.rooms[0].id;
        if (!parsed.analysis) parsed.analysis = { photo: null, area: "", checklist: [], notes: "" };
        return parsed;
      } catch {
        return buildDefaultState();
      }
    }

    let state = loadState();
    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function getRoomDef(id) { return ROOM_DEFS.find(r => r.id === id); }
    function getRoomState(id) { return state.rooms.find(r => r.id === id); }
    function getSelectedId() { return state.selectedId; }
    function isClanSelected() { return state.selectedId === "__clan__"; }
    function isAnalysisSelected() { return state.selectedId === "__analysis__"; }

    function getSelectedRoomDef() { return (isClanSelected() || isAnalysisSelected()) ? null : getRoomDef(getSelectedId()); }
    function getSelectedRoomState() { return (isClanSelected() || isAnalysisSelected()) ? null : getRoomState(getSelectedId()); }

    let audioCtx = null;
    function ensureAudioContext() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playGong() {
      try {
        ensureAudioContext();
        const ctx = audioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        const now = ctx.currentTime;

        osc.type = "sine";
        osc.frequency.setValueAtTime(700, now);
        osc.frequency.exponentialRampToValueAtTime(200, now + 0.8);

        gain.gain.setValueAtTime(0.001, now);
        gain.gain.exponentialRampToValueAtTime(0.7, now + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 1.0);

        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(now);
        osc.stop(now + 1.1);
      } catch {}
    }

    const celebrationLayer = document.getElementById("celebrationLayer");

    function spawnCoin(xPercent, yPercent, content = "ü™ô") {
      const el = document.createElement("div");
      el.className = "coin";
      el.style.left = xPercent + "%";
      el.style.top = yPercent + "%";
      el.textContent = content;
      celebrationLayer.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }

    function showWinFlash(text) {
      const flash = document.createElement("div");
      flash.className = "win-flash";
      flash.innerHTML = `<span>${text}</span><span>‚ú®</span>`;
      celebrationLayer.appendChild(flash);
      setTimeout(() => flash.remove(), 900);
    }

    function triggerCelebration(big = false) {
      celebrationLayer.classList.remove("hidden");
      const centerX = 50;
      const centerY = big ? 40 : 55;
      const count = big ? 24 : 14;
      for (let i = 0; i < count; i++) {
        const spreadX = (Math.random() - 0.5) * 50;
        const offsetY = (Math.random() - 0.5) * 25;
        setTimeout(() => {
          spawnCoin(centerX + spreadX, centerY + offsetY, "ü™ô");
        }, i * 30);
      }
      showWinFlash(big ? "GoodCoin Clan-Bonus" : "Clean-Up Win");
      setTimeout(() => {
        if (!celebrationLayer.children.length) {
          celebrationLayer.classList.add("hidden");
        }
      }, 1300);
    }

    const roomTabsEl = document.getElementById("roomTabs");
    const totalCoinsTextEl = document.getElementById("totalCoinsText");
    const totalTasksTextEl = document.getElementById("totalTasksText");
    const totalProgressEl = document.getElementById("totalProgress");
    const personalBestTextEl = document.getElementById("personalBestText");
    const clanPointsTextEl = document.getElementById("clanPointsText");

    const roomEmojiEl = document.getElementById("roomEmoji");
    const roomNameEl = document.getElementById("roomName");
    const roomInfoEl = document.getElementById("roomInfo");
    const roomLabelTopEl = document.getElementById("roomLabelTop");
       const roomLabelTipEl = document.getElementById("roomLabelTip");
    const obj1El = document.getElementById("obj1");
    const obj2El = document.getElementById("obj2");
    const obj3El = document.getElementById("obj3");
    const obj4El = document.getElementById("obj4");
    const obj5El = document.getElementById("obj5");
    const obj6El = document.getElementById("obj6");
    const kitchenPhotoEl = document.getElementById("kitchenPhoto");

    const taskListEl = document.getElementById("taskList");
    const roomStatsTextEl = document.getElementById("roomStatsText");
    const rewardLineEl = document.getElementById("rewardLine");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const resetTaskBtn = document.getElementById("resetTaskBtn");
    const renameInput = document.getElementById("renameInput");

    const beforeInputEl = document.getElementById("beforeInput");
    const afterInputEl = document.getElementById("afterInput");
    const beforeImgEl = document.getElementById("beforeImage");
    const afterImgEl = document.getElementById("afterImage");
    const beforePlaceholderEl = document.getElementById("beforePlaceholder");
    const afterPlaceholderEl = document.getElementById("afterPlaceholder");

    const shareCheckboxEl = document.getElementById("shareCheckbox");
    const clanBadgeContainerEl = document.getElementById("clanBadgeContainer");

    const roomViewEl = document.getElementById("roomView");
    const clanViewEl = document.getElementById("clanView");
    const analysisViewEl = document.getElementById("analysisView");
    const clanSummaryTextEl = document.getElementById("clanSummaryText");
    const clanRoomListEl = document.getElementById("clanRoomList");

    const analysisImageEl = document.getElementById("analysisImage");
    const analysisPlaceholderEl = document.getElementById("analysisPlaceholder");
    const analysisFileInputEl = document.getElementById("analysisFileInput");
    const analysisAreaSelectEl = document.getElementById("analysisAreaSelect");
    const analysisGenerateBtnEl = document.getElementById("analysisGenerateBtn");
    const analysisChecklistEl = document.getElementById("analysisChecklist");
    const analysisStatsTextEl = document.getElementById("analysisStatsText");
    const analysisNotesEl = document.getElementById("analysisNotes");

    function coinsForRoom(r) {
      const total = r.tasks.length;
      const done = r.tasks.filter(t => t.done).length;
      const fraction = total ? done / total : 0;
      return Math.round(r.rewardTotal * fraction);
    }

    function computeTotals() {
      let totalTasks = 0;
      let totalDone = 0;
      let totalCoins = 0;
      state.rooms.forEach(r => {
        const done = r.tasks.filter(t => t.done).length;
        const total = r.tasks.length;
        const fraction = total ? done / total : 0;
        const coins = Math.round(r.rewardTotal * fraction);
        totalTasks += total;
        totalDone += done;
        totalCoins += coins;
      });
      return { totalTasks, totalDone, totalCoins };
    }

    function updatePersonalBest() {
      const { totalCoins } = computeTotals();
      if (totalCoins > state.personalBest) {
        state.personalBest = totalCoins;
        saveState();
      }
    }

    function updateClanPointsFromRooms() {
      state.clanPoints = state.rooms.reduce((sum, r) => sum + (r.clanAwardedPoints || 0), 0);
    }

    function renderTabs() {
      roomTabsEl.innerHTML = "";
      const selectedId = getSelectedId();

      state.rooms.forEach(r => {
        const done = r.tasks.filter(t => t.done).length;
        const total = r.tasks.length;
        const btn = document.createElement("button");
        btn.className = "room-tab" + (r.id === selectedId ? "active" : "");
        btn.innerHTML = `
          <span class="room-tab-emoji">${r.emoji}</span>
          <span>${r.name}</span>
          <span class="tiny">${done}/${total}</span>
        `;
        btn.addEventListener("click", () => {
          state.selectedId = r.id;
          saveState();
          renderAll();
        });
        roomTabsEl.appendChild(btn);
      });

      const clanBtn = document.createElement("button");
      clanBtn.className = "room-tab" + (isClanSelected() ? "active" : "");
      clanBtn.innerHTML = `
        <span class="room-tab-emoji">üõ°Ô∏è</span>
        <span>Clan</span>
      `;
      clanBtn.addEventListener("click", () => {
        state.selectedId = "__clan__";
        saveState();
        renderAll();
      });
      roomTabsEl.appendChild(clanBtn);

      const analysisBtn = document.createElement("button");
      analysisBtn.className = "room-tab" + (isAnalysisSelected() ? "active" : "");
      analysisBtn.innerHTML = `
        <span class="room-tab-emoji">üì∑</span>
        <span>Analyse</span>
      `;
      analysisBtn.addEventListener("click", () => {
        state.selectedId = "__analysis__";
        saveState();
        renderAll();
      });
      roomTabsEl.appendChild(analysisBtn);
    }

    function renderHeaderTotals() {
      updatePersonalBest();
      updateClanPointsFromRooms();
      const { totalTasks, totalDone, totalCoins } = computeTotals();
      totalCoinsTextEl.textContent = totalCoins + " GoodCoins heute";
      if (!totalTasks) {
        totalTasksTextEl.textContent = "Noch keine Aufgaben";
        totalProgressEl.style.width = "0%";
      } else {
        totalTasksTextEl.textContent = totalDone + " von " + totalTasks + " Aufgaben erledigt";
        const percent = (totalDone / totalTasks) * 100;
        totalProgressEl.style.width = percent + "%";
      }
      personalBestTextEl.textContent = "Dein Tagesrekord: " + state.personalBest + " GoodCoins";
      clanPointsTextEl.textContent = "Clan-Punkte gesamt: " + state.clanPoints;
    }

    function renderRoomVisual() {
      const def = getSelectedRoomDef();
      const r = getSelectedRoomState();
      if (!def || !r) return;

      roomEmojiEl.textContent = r.emoji;
      roomNameEl.textContent = r.name;
      roomInfoEl.textContent = def.info;
      roomLabelTopEl.textContent = "Virtuelle Ansicht: " + def.name;
      roomLabelTipEl.textContent = "Nur Symbole anklicken ‚Äì alles z√§hlt als kleine Mission.";

      const allObjects = [obj1El, obj2El, obj3El, obj4El, obj5El, obj6El];
      const defObjects = def.visuals || [];

      if (def.id === "kitchen") {
        kitchenPhotoEl.style.display = "block";
        kitchenPhotoEl.src = "https://via.placeholder.com/800x400?text=Kuechen+Spuele";
      } else {
        kitchenPhotoEl.style.display = "none";
      }

      allObjects.forEach((objEl, index) => {
        const vo = defObjects[index];
        if (!vo) {
          objEl.style.display = "none";
          objEl.onclick = null;
        } else {
          objEl.style.display = "flex";
          objEl.style.left = vo.style.left;
          objEl.style.top = vo.style.top;
          objEl.innerHTML = `<span class="room-object-emoji">${vo.emoji}</span>`;
          const voLocal = vo;
          objEl.onclick = () => {
            const roomState = getSelectedRoomState();
            if (!roomState) return;
            const task = roomState.tasks[voLocal.taskIndex];
            if (!task) return;
            const wasDone = task.done;
            task.done = !task.done;
            saveState();
            renderRoomTasks();
            renderHeaderTotals();
            renderTabs();
            if (!wasDone && task.done) {
              playGong();
              triggerCelebration(false);
            }
          };
        }
      });
    }

    const taskListElRef = taskListEl;

    function renderRoomTasks() {
      const def = getSelectedRoomDef();
      const r = getSelectedRoomState();
      if (!def || !r) return;

      taskListElRef.innerHTML = "";
      r.tasks.forEach((task, i) => {
        const li = document.createElement("li");
        li.className = "task-item";
        const id = "task_" + r.id + "_" + i;
        li.innerHTML = `
          <input type="checkbox" id="${id}" ${task.done ? "checked" : ""}>
          <label class="task-label ${task.done ? "done" : ""}" for="${id}">
            ${task.text}
            <div class="task-meta">Teil der GoodCoin-Belohnung f√ºr dieses Zimmer</div>
          </label>
        `;
        const cb = li.querySelector("input");
        const label = li.querySelector("label");
        cb.addEventListener("change", () => {
          const wasDone = task.done;
          task.done = cb.checked;
          label.classList.toggle("done", cb.checked);
          saveState();
          renderHeaderTotals();
          renderTabs();
          renderRoomStatsLine();
          if (!wasDone && task.done) {
            playGong();
            triggerCelebration(false);
          }
        });
        taskListElRef.appendChild(li);
      });

      renameInput.value = r.name;
      renderRoomStatsLine();
    }

    function renderRoomStatsLine() {
      const def = getSelectedRoomDef();
      const r = getSelectedRoomState();
      if (!def || !r) return;
      const done = r.tasks.filter(t => t.done).length;
      const total = r.tasks.length;
      const coins = coinsForRoom(r);
      roomStatsTextEl.textContent = done + " von " + total + " Aufgaben erledigt ‚Äì " + coins + " GoodCoins in diesem Zimmer.";
      rewardLineEl.textContent = "Wenn alles erledigt ist, bringt dieses Zimmer " + def.rewardTotal + " GoodCoins.";
    }

    function renderPhotosAndShare() {
      const r = getSelectedRoomState();
      if (!r) return;

      if (r.beforePhoto) {
        beforeImgEl.src = r.beforePhoto;
        beforeImgEl.style.display = "block";
        beforePlaceholderEl.style.display = "none";
      } else {
        beforeImgEl.style.display = "none";
        beforePlaceholderEl.style.display = "block";
      }

      if (r.afterPhoto) {
        afterImgEl.src = r.afterPhoto;
        afterImgEl.style.display = "block";
        afterPlaceholderEl.style.display = "none";
      } else {
        afterImgEl.style.display = "none";
        afterPlaceholderEl.style.display = "block";
      }

      shareCheckboxEl.checked = r.share;
      renderClanBadge();
    }

    function renderClanBadge() {
      clanBadgeContainerEl.innerHTML = "";
      const r = getSelectedRoomState();
      if (!r) return;
      const hasTasksDone = r.tasks.some(t => t.done);
      if (r.share && hasTasksDone) {
        const badge = document.createElement("div");
        badge.className = "clan-badge";
        badge.innerHTML = `
          <div class="clan-symbol">GC</div>
          <div>
            GoodCoin Clan-Bonus freigeschaltet: Die GoodCoins aus diesem Zimmer wurden deinem Clan gutgeschrieben.
          </div>
        `;
        clanBadgeContainerEl.appendChild(badge);
      }
    }

    function renderClanView() {
      updateClanPointsFromRooms();
      clanSummaryTextEl.textContent = state.clanPoints
        ? "Bisher gesammelte Clan-Punkte: " + state.clanPoints + " GoodCoins."
        : "Noch keine Clan-Punkte gesammelt.";

      clanRoomListEl.innerHTML = "";
      state.rooms.forEach(r => {
        const points = r.clanAwardedPoints || 0;
        const li = document.createElement("li");
        li.className = "clan-item";
        const done = r.tasks.filter(t => t.done).length;
        const total = r.tasks.length;
        li.innerHTML = `
          <span><span>${r.emoji}</span><span>${r.name}</span></span>
          <span>${points} GC ‚Äì ${done}/${total} Aufgaben erledigt</span>
        `;
        clanRoomListEl.appendChild(li);
      });
    }

    function fileToBase64(file, callback) {
      const reader = new FileReader();
      reader.onload = e => callback(e.target.result);
      reader.readAsDataURL(file);
    }

    addTaskBtn.addEventListener("click", () => {
      const r = getSelectedRoomState();
      if (!r) return;
      const text = prompt("Neue Mini-Mission f√ºr dieses Zimmer eingeben:");
      if (!text) return;
      r.tasks.push({ text: text.trim(), done: false });
      saveState();
      renderAll();
    });

    resetTaskBtn.addEventListener("click", () => {
      const r = getSelectedRoomState();
      if (!r) return;
      if (!confirm("Alle Haken in diesem Zimmer f√ºr heute l√∂schen?")) return;
      r.tasks.forEach(t => t.done = false);
      r.clanAwarded = false;
      r.share = false;
      r.clanAwardedPoints = 0;
      saveState();
      renderAll();
    });

    renameInput.addEventListener("change", () => {
      const r = getSelectedRoomState();
      if (!r) return;
      const value = renameInput.value.trim();
      if (!value) return;
      r.name = value;
      saveState();
      renderTabs();
      roomNameEl.textContent = r.name;
    });

    beforeInputEl.addEventListener("change", e => {
      const r = getSelectedRoomState();
      if (!r) { e.target.value = ""; return; }
      const file = e.target.files[0];
      if (!file) return;
      fileToBase64(file, data => {
        r.beforePhoto = data;
        saveState();
        renderPhotosAndShare();
      });
    });

    afterInputEl.addEventListener("change", e => {
      const r = getSelectedRoomState();
      if (!r) { e.target.value = ""; return; }
      const file = e.target.files[0];
      if (!file) return;
      fileToBase64(file, data => {
        r.afterPhoto = data;
        saveState();
        renderPhotosAndShare();
      });
    });

    shareCheckboxEl.addEventListener("change", () => {
      const r = getSelectedRoomState();
      if (!r) return;
      const anyDone = r.tasks.some(t => t.done);
      const coins = coinsForRoom(r);
      r.share = shareCheckboxEl.checked;
      if (r.share && anyDone && !r.clanAwarded && coins > 0) {
        r.clanAwarded = true;
        r.clanAwardedPoints += coins;
        updateClanPointsFromRooms();
        saveState();
        triggerCelebration(true);
      } else {
        saveState();
      }
      renderHeaderTotals();
      renderClanBadge();
      renderClanView();
    });

    function renderAnalysisTab() {
      const a = state.analysis || { photo: null, area: "", checklist: [], notes: "" };

      if (a.photo) {
        analysisImageEl.src = a.photo;
        analysisImageEl.style.display = "block";
        analysisPlaceholderEl.style.display = "none";
      } else {
        analysisImageEl.style.display = "none";
        analysisPlaceholderEl.style.display = "block";
      }

      analysisAreaSelectEl.value = a.area || "";
      analysisNotesEl.value = a.notes || "";
      analysisChecklistEl.innerHTML = "";
      if (a.checklist && a.checklist.length) {
        a.checklist.forEach(item => {
          const li = document.createElement("li");
          li.innerHTML = `
            <input type="checkbox">
            <span>${item}</span>
          `;
          analysisChecklistEl.appendChild(li);
        });
        analysisStatsTextEl.textContent =
          "Aktuelle Checkliste: " + a.checklist.length + " Vorschl√§ge f√ºr diese Zone.";
      } else {
        analysisStatsTextEl.textContent =
          "W√§hle einen Bereich aus und klicke auf Checkliste erzeugen.";
      }
    }

    analysisFileInputEl.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      fileToBase64(file, data => {
        state.analysis.photo = data;
        saveState();
        renderAnalysisTab();
      });
    });

    analysisNotesEl.addEventListener("input", () => {
      state.analysis.notes = analysisNotesEl.value;
      saveState();
    });

    function generateChecklistForArea(area) {
      const def = ROOM_DEFS.find(r => r.id === area);
      if (!def) return [];
      return def.tasks.slice();
    }

    analysisGenerateBtnEl.addEventListener("click", () => {
      const area = analysisAreaSelectEl.value;
      if (!area) {
        alert("Bitte zuerst einen Bereich ausw√§hlen.");
        return;
      }
      const tasks = generateChecklistForArea(area);
      state.analysis.area = area;
      state.analysis.checklist = tasks;
      saveState();
      triggerCelebration(false);
      renderAnalysisTab();
    });

    function renderAll() {
      renderTabs();
      renderHeaderTotals();
      if (isClanSelected()) {
        roomViewEl.style.display = "none";
        analysisViewEl.style.display = "none";
        clanViewEl.style.display = "grid";
        renderClanView();
      } else if (isAnalysisSelected()) {
        roomViewEl.style.display = "none";
        clanViewEl.style.display = "none";
        analysisViewEl.style.display = "grid";
        renderAnalysisTab();
      } else {
        clanViewEl.style.display = "none";
        analysisViewEl.style.display = "none";
        roomViewEl.style.display = "grid";
        renderRoomVisual();
        renderRoomTasks();
        renderPhotosAndShare();
      }
    }

    renderAll();
  </script>
</body>
</html>
